# æ–¹æ¡ˆ A + B æ¶æ§‹ç¸½çµ

## ğŸ“Š ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     React å‰ç«¯ (3000)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AIMatchingPage | Pipeline | CandidateList            â”‚   â”‚
â”‚  â”‚ æ”¹ç‹€æ…‹ â†’ PUT /api/candidates/:id                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“â†‘
                     (HTTP REST API)
                             â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Node.js å¾Œç«¯ (3001)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Express Router (routes-candidates.js)                â”‚   â”‚
â”‚  â”‚ - PUT /api/candidates/:id                            â”‚   â”‚
â”‚  â”‚ - GET /api/candidates/:id                            â”‚   â”‚
â”‚  â”‚ - GET /api/candidates                                â”‚   â”‚
â”‚  â”‚ - POST /api/sync/pending                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                              â†“                â”‚
â”‚   candidatesService.js              (éåŒæ­¥)               â”‚
â”‚   - updateCandidateStatus()         sheetsService-v2-sql   â”‚
â”‚   - createCandidate()               - updateCell()         â”‚
â”‚   - saveAIMatches()                 - findCandidateRowNum()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                          â†“
   (å³æ™‚å¯«å…¥)                              (ç•°æ­¥åŒæ­¥ï¼Œ5s)
        â†“                                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL          â”‚                 â”‚  Google Sheets     â”‚
â”‚ (True Source)        â”‚                 â”‚ (Report Layer)     â”‚
â”‚                      â”‚                 â”‚                    â”‚
â”‚ candidates_pipeline  â”‚ â—„â”€â”€â”€â”€ è®€ â”€â”€â”€â”€â–º  â”‚ Resume Pool Sheet  â”‚
â”‚ google_sheets_sync   â”‚  (Sync Log)     â”‚ (A-U æ¬„)           â”‚
â”‚ candidates_sync      â”‚                 â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•¸æ“šæµç¨‹

### æµç¨‹ 1ï¼šæ”¹ç‹€æ…‹ï¼ˆæ ¸å¿ƒï¼‰

```
å‰ç«¯ï¼šæ”¹ç‹€æ…‹ â†’ "å·²è¯ç¹«"
  â†“
API: PUT /api/candidates/123
  {status: "å·²è¯ç¹«", name: "John"}
  â†“
candidatesService.updateCandidateStatus()
  â†“
  â”œâ†’ sqlService.updateCandidateStatus()
  â”‚  â””â†’ PostgreSQL candidates_pipeline è¡¨ (å³æ™‚)
  â”‚  â””â†’ è¨˜éŒ„åˆ° google_sheets_sync_log (pending)
  â”‚
  â””â†’ (éåŒæ­¥) sheetsService.updateCell()
     â””â†’ Google Sheets (S æ¬„) (5s å¾Œ)
     â””â†’ æ¨™è¨˜ç‚º synced_to_sheets = TRUE
```

### æµç¨‹ 2ï¼šè®€å€™é¸äºº

```
å‰ç«¯ï¼šGET /api/candidates
  â†“
API: candidatesService.getAllCandidates()
  â†“
sqlService.getAllCandidatePipelines()
  â†“
PostgreSQL æŸ¥è©¢ (å¿«ï¼Œ<100ms)
  â†“
è¿”å›å€™é¸äººåˆ—è¡¨
```

### æµç¨‹ 3ï¼šå®šæœŸåŒæ­¥ï¼ˆCronï¼‰

```
æ¯ 5 åˆ†é˜è§¸ç™¼ä¸€æ¬¡
  â†“
candidatesService.syncPendingChanges()
  â†“
æŸ¥è©¢ google_sheets_sync_log (synced_to_sheets = FALSE)
  â†“
FOR EACH pending:
  - syncToGoogleSheets(candidateId, newStatus)
  - æ‰¾ Sheets è¡Œè™Ÿ
  - æ›´æ–° Status æ¬„
  - æ¨™è¨˜å®Œæˆ
```

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
server/
â”œâ”€â”€ server.js                    # ä¸»ä¼ºæœå™¨å…¥å£
â”œâ”€â”€ .env                         # ç’°å¢ƒè®Šæ•¸ (DATABASE_URL, SHEET_ID)
â”œâ”€â”€ 
â”œâ”€â”€ sqlService.js                # PostgreSQL æœå‹™å±¤
â”‚   â”œâ”€â”€ getCandidatePipeline()
â”‚   â”œâ”€â”€ updateCandidateStatus()
â”‚   â”œâ”€â”€ saveAIMatchScores()
â”‚   â”œâ”€â”€ getPendingSyncToSheets()
â”‚   â””â”€â”€ markSyncToSheetsDone()
â”‚
â”œâ”€â”€ sheetsService-v2-sql.js      # Google Sheets æœå‹™å±¤
â”‚   â”œâ”€â”€ getAllCandidates()
â”‚   â”œâ”€â”€ findCandidateRowNum()
â”‚   â”œâ”€â”€ updateCell()
â”‚   â”œâ”€â”€ appendCandidateRow()
â”‚   â””â”€â”€ updateCandidateStatus()
â”‚
â”œâ”€â”€ candidatesService.js         # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”œâ”€â”€ updateCandidateStatus()  # æ ¸å¿ƒï¼šåŒæ™‚æ›´æ–° SQL + Sheets
â”‚   â”œâ”€â”€ createCandidate()
â”‚   â”œâ”€â”€ getCandidate()
â”‚   â”œâ”€â”€ saveAIMatches()
â”‚   â””â”€â”€ syncPendingChanges()
â”‚
â”œâ”€â”€ routes-candidates.js         # REST API è·¯ç”±å±¤
â”‚   â”œâ”€â”€ PUT /api/candidates/:id
â”‚   â”œâ”€â”€ GET /api/candidates/:id
â”‚   â”œâ”€â”€ GET /api/candidates
â”‚   â”œâ”€â”€ POST /api/candidates
â”‚   â”œâ”€â”€ POST /api/candidates/:id/ai-matches
â”‚   â””â”€â”€ POST /api/sync/pending
â”‚
â”œâ”€â”€ db/
â”‚   â””â”€â”€ init-postgres.sql        # PostgreSQL åˆå§‹åŒ–è…³æœ¬
â”‚
â”œâ”€â”€ DEPLOYMENT.md                # éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ FRONTEND-INTEGRATION.md      # å‰ç«¯æ”¹é€²æŒ‡å—
â””â”€â”€ ARCHITECTURE.md              # æœ¬æª”æ¡ˆ
```

---

## ğŸ”‘ é—œéµæ±ºç­–

| æ±ºç­– | åŸå›  | å„ªé» | ç¼ºé» |
|------|------|------|------|
| **SQL å„ªå…ˆ** | ç„¡é ˆç­‰å¾… Sheets API | å¿«é€Ÿå›æ‡‰ï¼ˆ<50msï¼‰ | ç•°æ­¥åŒæ­¥å¯èƒ½å»¶é² |
| **éåŒæ­¥ Sheets åŒæ­¥** | é¿å… API é˜»æ“‹ | ä¸å½±éŸ¿ç”¨æˆ¶é«”é©— | å¯èƒ½å¤±æ•—ï¼ˆæœ‰ retryï¼‰ |
| **å®šæœŸ Cron åŒæ­¥** | ä¿è­‰æœ€çµ‚ä¸€è‡´æ€§ | ä¸æ€•å–®æ¬¡å¤±æ•— | 5 åˆ†é˜å»¶é² |
| **ä¿ç•™ Google Sheets** | ç¾æœ‰ç”¨æˆ¶ç¿’æ…£ | é›¶é·ç§»æˆæœ¬ | å¤šä¸€å±¤åŒæ­¥ |

---

## âš¡ æ€§èƒ½æŒ‡æ¨™

| æ“ä½œ | æ™‚é–“ | å‚™è¨» |
|------|------|------|
| æ”¹ç‹€æ…‹ (SQL) | <50ms | å³æ™‚ |
| æ”¹ç‹€æ…‹ (Sheets) | 2-5s | éåŒæ­¥ï¼Œç„¡é˜»æ“‹ |
| è®€å€™é¸äºº (SQL) | <100ms | å¿«é€Ÿ |
| è®€å€™é¸äºº (Sheets Fallback) | 500-1000ms | æ…¢ï¼Œä½†æœ‰å‚™ä»½ |
| æ‰¹é‡æ”¹ 20 ç­† | 2s (SQL) + 30s (Sheets) | é–“éš”æ§åˆ¶ |

---

## ğŸ›¡ï¸ å®¹éŒ¯æ©Ÿåˆ¶

### å–®é»æ•…éšœåˆ†æ

```
æ•…éšœé» 1: PostgreSQL é€£ç·šæ–·é–‹
â”œâ”€ åµæ¸¬ï¼šAPI /health endpoint æª¢æŸ¥
â”œâ”€ æ¢å¾©ï¼šè‡ªå‹• reconnect + retry
â””â”€ æ™‚é–“ï¼š<30s

æ•…éšœé» 2: Google Sheets API å¤±æ•—
â”œâ”€ åµæ¸¬ï¼šsync_timestamp å’Œ synced_to_sheets
â”œâ”€ æ¢å¾©ï¼šä¸‹ä¸€å€‹ Cron cycle é‡è©¦
â””â”€ æ™‚é–“ï¼šæœ€å¤š 5 åˆ†é˜

æ•…éšœé» 3: å‰ç«¯æ”¹ç‹€æ…‹å¤±æ•—
â”œâ”€ åµæ¸¬ï¼šAPI è¿”å› error
â”œâ”€ æ¢å¾©ï¼šè‡ªå‹•å›æ»¾æœ¬åœ°ç‹€æ…‹
â””â”€ æ™‚é–“ï¼šç«‹å³
```

---

## ğŸ“Š æ–¹æ¡ˆå°æ¯”

### æ–¹æ¡ˆ Aï¼ˆå¿«é€Ÿä¿®å¾©ï¼‰
```
å‰ç«¯æ”¹ç‹€æ…‹ â†’ API â†’ Google Sheets
â””â”€ æ™‚é–“ï¼š15 åˆ†é˜
â””â”€ æ•ˆæœï¼šæ”¹ç‹€æ…‹ç«‹å³ä¿å­˜ âœ…
â””â”€ ä¾·é™ï¼šä¾è³´ Sheets API é€Ÿåº¦
```

### æ–¹æ¡ˆ Bï¼ˆé•·æœŸæœ€ä½³ï¼‰
```
å‰ç«¯æ”¹ç‹€æ…‹ â†’ API â†’ SQL â†â†’ Google Sheets
â””â”€ æ™‚é–“ï¼š1-2 å°æ™‚
â””â”€ æ•ˆæœï¼šå¿«é€Ÿ + æœ€çµ‚ä¸€è‡´æ€§ âœ…
â””â”€ å„ªå‹¢ï¼šæ¶æ§‹æ­£ç¢ºï¼Œæ˜“æ–¼æ“´å±•
```

### æ–¹æ¡ˆ A + Bï¼ˆä»Šæ—¥å®Œæˆ âœ…ï¼‰
```
å‰ç«¯æ”¹ç‹€æ…‹ â†’ API â†’ SQL (å³æ™‚) + Google Sheets (éåŒæ­¥)
â””â”€ æ™‚é–“ï¼šå·²å®Œæˆ âœ…
â””â”€ æ•ˆæœï¼šå…©è€…çµåˆçš„æ‰€æœ‰å„ªé» âœ…âœ…
```

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“´å±•

### Phase 1ï¼ˆä»Šæ—¥ï¼‰
- [x] PostgreSQL åˆå§‹åŒ–
- [x] API å±¤å¯¦ç¾
- [x] å‰ç«¯æ”¹é€²
- [x] éƒ¨ç½²åˆ° Zeabur

### Phase 2ï¼ˆä¸‹é€±ï¼‰
- [ ] æ–°å¢ç”¨æˆ¶æ¬Šé™ç®¡ç†ï¼ˆå¤šé¡§å•éš”é›¢ï¼‰
- [ ] å¯©è¨ˆæ—¥èªŒï¼ˆèª°æ”¹äº†ä»€éº¼æ™‚é–“ï¼‰
- [ ] æ‰¹é‡æ“ä½œ API
- [ ] å€™é¸äººæ¨™ç±¤ç³»çµ±

### Phase 3ï¼ˆ2 é€±å¾Œï¼‰
- [ ] ç§»é™¤ Google Sheets ä¾è³´ï¼ˆå®Œå…¨é·ç§»åˆ° SQLï¼‰
- [ ] è¡Œå‹•æ‡‰ç”¨ï¼ˆiOS/Androidï¼‰
- [ ] å¯¦æ™‚é€šçŸ¥ï¼ˆWebSocketï¼‰
- [ ] AI è‡ªå‹•åˆ†é¡

---

## ğŸ“ å¿«é€Ÿåƒè€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# æœ¬åœ°é–‹ç™¼
node server/server.js

# PostgreSQL é€£ç·š
psql postgresql://root:etUh2zkR4Mr8gfWLs059S7Dm1T6Yby3Q@tpe1.clusters.zeabur.com:27883/zeabur

# æŸ¥è©¢å€™é¸äºº
SELECT * FROM candidates_pipeline WHERE consultant='Jacky' LIMIT 10;

# æŸ¥è©¢åŒæ­¥æ—¥èªŒ
SELECT * FROM google_sheets_sync_log WHERE synced_to_sheets=FALSE;

# æ‰‹å‹•åŒæ­¥
curl -X POST http://localhost:3001/api/sync/pending

# å¥åº·æª¢æŸ¥
curl http://localhost:3001/api/health
```

### ç’°å¢ƒè®Šæ•¸ï¼ˆè¨˜ä½é€™äº›ï¼‰

```bash
DATABASE_URL=postgresql://root:etUh2zkR4Mr8gfWLs059S7Dm1T6Yby3Q@tpe1.clusters.zeabur.com:27883/zeabur
SHEET_ID=1PunpaDAFBPBL_I76AiRYGXKaXDZvMl1c262SEtxRk6Q
PORT=3001
```

---

## âœ… é©—æ”¶æ¨™æº–

âœ… æ”¹ç‹€æ…‹ â†’ ä¸ç™»å‡º â†’ åˆ·æ–° â†’ ç‹€æ…‹ä¿ç•™
âœ… æ”¹ç‹€æ…‹ â†’ ç™»å‡º â†’ ç™»å…¥ â†’ ç‹€æ…‹ä¿ç•™
âœ… æ”¹ç‹€æ…‹ â†’ ç­‰ 5s â†’ Google Sheets åŒæ­¥
âœ… æ‰¹é‡æ”¹ç‹€æ…‹ â†’ ç„¡ API é™æµ
âœ… API éŸ¿æ‡‰æ™‚é–“ <100ms
âœ… PostgreSQL é›¶å®•æ©Ÿï¼ˆè‡ªå‹• reconnectï¼‰

---

**æ¶æ§‹å®Œæˆæ—¥æœŸ**: 2026-02-25
**ä½œè€…**: YuQi ğŸ¦
**ç‹€æ…‹**: âœ… å°±ç·’éƒ¨ç½²
